name: StegBrain Auto-Heal

on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 5 * * *" # daily 05:15 UTC (after global-status)

permissions:
  contents: write
  issues: write
  actions: read

jobs:
  auto_heal:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout StegBrain
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Read Brain State (fail-safe)
        id: state
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p meta
          FILE="meta/global_status.json"

          # If missing OR invalid JSON -> treat as broken (fail-closed)
          if [[ ! -f "$FILE" ]]; then
            echo "state=broken" >> "$GITHUB_OUTPUT"
            echo "reason=missing-global-status" >> "$GITHUB_OUTPUT"
            echo "Current state: broken"
            echo "Reason: missing-global-status"
            exit 0
          fi

          if ! python -m json.tool "$FILE" >/dev/null 2>&1; then
            echo "state=broken" >> "$GITHUB_OUTPUT"
            echo "reason=invalid-json" >> "$GITHUB_OUTPUT"
            echo "Current state: broken"
            echo "Reason: invalid-json"
            exit 0
          fi

          STATE="$(python - <<'PY'
import json
with open("meta/global_status.json","r",encoding="utf-8") as f:
    d=json.load(f)
print(d.get("state","broken"))
PY
)"
          REASON="$(python - <<'PY'
import json
with open("meta/global_status.json","r",encoding="utf-8") as f:
    d=json.load(f)
print(d.get("reason","no-reason"))
PY
)"

          echo "state=$STATE" >> "$GITHUB_OUTPUT"
          echo "reason=$REASON" >> "$GITHUB_OUTPUT"

          echo "Current state: $STATE"
          echo "Reason: $REASON"

      - name: Decide Heal
        id: decide
        shell: bash
        run: |
          set -euo pipefail
          STATE="${{ steps.state.outputs.state }}"

          if [[ "$STATE" == "ok" ]]; then
            echo "heal=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "heal=true" >> "$GITHUB_OUTPUT"

      - name: Trigger StegBrain recompute (self-fix)
        if: ${{ steps.decide.outputs.heal == 'true' }}
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GH_MULTI_REPO_PAT }}
        run: |
          set -euo pipefail

          if [[ -z "${GH_TOKEN:-}" ]]; then
            echo "::error title=Missing repo secret::GH_MULTI_REPO_PAT is not set in StegBrain repo secrets."
            exit 2
          fi

          curl -fsSL -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/StegVerse-Labs/StegBrain/dispatches \
            -d '{"event_type":"stegbrain-recompute"}'

      - name: Open/Log Heal Issue
        if: ${{ steps.decide.outputs.heal == 'true' }}
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "StegBrain auto-heal triggered ‚ùó"
          content-filepath: .github/ISSUE_TEMPLATE/auto_heal.md
          labels: "autofix,stegbrain,needs-attention"
          update-existing: true
          search-existing: "title"
