name: StegBrain Auto-Heal

on:
  workflow_dispatch:
  schedule:
    - cron: "*/60 * * * *"

permissions:
  contents: write
  issues: write

jobs:
  auto_heal:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout StegBrain
        uses: actions/checkout@v4

      - name: Read Brain State
        id: brain
        run: |
          if [ ! -f meta/global_status.json ]; then
            echo "state=unknown" >> $GITHUB_OUTPUT
            echo "reason=global_status.json missing" >> $GITHUB_OUTPUT
            exit 0
          fi
          STATE=$(jq -r '.cluster.state' meta/global_status.json)
          REASON=$(jq -r '.prod_gate.reason' meta/global_status.json)
          echo "state=$STATE" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

      - name: Decide Heal
        id: decide
        run: |
          STATE="${{ steps.brain.outputs.state }}"
          if [ "$STATE" = "ok" ]; then
            echo "heal_needed=false" >> $GITHUB_OUTPUT
          else
            echo "heal_needed=true" >> $GITHUB_OUTPUT
          fi

      - name: Trigger StegDB Full Cycle
        if: steps.decide.outputs.heal_needed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Triggering StegDB full-cycle via repository_dispatch..."
          curl -s -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/StegVerse-Labs/StegDB/dispatches \
            -d '{"event_type":"stegbrain-full-cycle"}'

      - name: Open/Log Heal Issue
        if: steps.decide.outputs.heal_needed == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          STATE="${{ steps.brain.outputs.state }}"
          REASON="${{ steps.brain.outputs.reason }}"
          TITLE="Auto-heal triggered - cluster state: $STATE"
          BODY="StegBrain detected non-OK cluster state.\n\nState: \`$STATE\`\nReason: \`$REASON\`\n\nStegDB full-cycle has been triggered via repository_dispatch \`stegbrain-full-cycle\`.\n\nCheck StegVerse-Labs/StegDB workflows & repair plans for details."

          gh issue create \
            --title "$TITLE" \
            --body "$BODY" || echo "Issue creation failed (maybe duplicate); continuing."
