name: StegBrain - Gate

on:
  workflow_dispatch: {}
  workflow_call:
    inputs:
      require_state:
        description: "Required cluster state to pass (usually ok)"
        required: false
        default: "ok"
        type: string

permissions:
  contents: read

jobs:
  gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout StegBrain
        uses: actions/checkout@v4

      - name: Read meta/global_status.json
        id: read
        shell: bash
        run: |
          set -euo pipefail

          FILE="meta/global_status.json"
          if [[ ! -f "$FILE" ]]; then
            echo "::error title=Missing global_status.json::StegBrain meta/global_status.json not found (fail-closed)."
            exit 1
          fi

          echo "Global status file (raw):"
          cat "$FILE"

          # Hard-validate JSON so we fail with a clear error instead of a stack trace
          if ! python -m json.tool "$FILE" >/dev/null 2>&1; then
            echo "::error title=Invalid JSON in global_status.json::File is not valid JSON (possible log contamination)."
            exit 1
          fi

          STATE="$(python - <<'PY'
import json
with open("meta/global_status.json","r",encoding="utf-8") as f:
    d = json.load(f)
print(d.get("state","broken"))
PY
)"
          REASON="$(python - <<'PY'
import json
with open("meta/global_status.json","r",encoding="utf-8") as f:
    d = json.load(f)
print(d.get("reason","no-reason"))
PY
)"

          echo "state=$STATE" >> "$GITHUB_OUTPUT"
          echo "reason=$REASON" >> "$GITHUB_OUTPUT"

      - name: Enforce gate
        shell: bash
        run: |
          set -euo pipefail
          REQUIRED="${{ inputs.require_state }}"
          STATE="${{ steps.read.outputs.state }}"
          REASON="${{ steps.read.outputs.reason }}"

          echo "Required: $REQUIRED"
          echo "Actual:   $STATE"
          echo "Reason:   $REASON"

          if [[ "$STATE" != "$REQUIRED" ]]; then
            echo "::error title=StegBrain gate blocked::Required '$REQUIRED' but got '$STATE' ($REASON)"
            exit 1
          fi

          echo "âœ… Gate passed."
